<project name="eclipse" default="all" basedir="..">
    <description>Dacapo Eclipse benchmark</description>
	<property file="ant/dacapo.properties"/>
	
    <property name="eclipse.version" value="3.1.2"/>
    <property name="eclipse.drop" value="200601181600"/>
    <property name="eclipse.url" value="http://archive.eclipse.org/eclipse/downloads/drops/R-${eclipse.version}-${eclipse.drop}"/>
   	
    <target name="source">
        <get src="${eclipse.url}/eclipse-SDK-${eclipse.version}-linux-gtk.tar.gz"
         dest="${sources}/eclipse-SDK-${eclipse.version}-linux.gtk.tar.gz"
         usetimestamp="true"/>
        <get src="${eclipse.url}/eclipse-Automated-Tests-${eclipse.version}.zip"
         dest="${sources}/eclipse-Automated-Tests-${eclipse.version}.zip"
         usetimestamp="true"/>
    </target>
    
    <!-- Download and build -->
    <target name="all" description="download and build the benchmark">
      <antcall target="source"/>
      <antcall target="build"/>
    </target>
	
    <target name="build" depends="benchmark,data,harness"/>
    
    <target name="harness" description="Build eclipse">
        <javac     srcdir="${bmsrc}" 
            source="1.4"
                destdir="${build}" includes="dacapo/eclipse/*.java"
                debug="true" debuglevel="lines,vars,source">
            <classpath>
                <pathelement path="${build}"/>
                <pathelement path="${build.src}/eclipse/eclipse/plugins/org.eclipse.osgi_${eclipse.version}.jar"/>
                <pathelement path="${build.src}/eclipse/eclipse/plugins/org.eclipse.core.runtime_${eclipse.version}.jar"/>
                <pathelement path="${build.src}/eclipse/eclipse/plugins/org.eclipse.jdt.launching_3.1.0.jar"/>
            </classpath>
        </javac>
    </target>
    
    <target name="benchmark" description="Build eclipse">
        <property name="eclipse-top" value="${build.src}/eclipse/eclipse"/>

        <untar src="${sources}/eclipse-SDK-${eclipse.version}-linux.gtk.tar.gz" dest="${build.src}/eclipse/" compression="gzip"/>
        <unzip src="${sources}/eclipse-Automated-Tests-${eclipse.version}.zip" dest="${build.src}/eclipse/">
            <patternset>
                <include name="eclipse-testing/eclipse-junit-tests-M*.zip"/>
            </patternset>
        </unzip>
        <unzip dest="${build.src}/eclipse/">
            <fileset dir="${build.src}/eclipse/eclipse-testing/">
                <include name="eclipse-junit-tests-M*.zip"/>
            </fileset>
        </unzip>
        <delete dir="${build.src}/eclipse/eclipse-testing"/> 
    </target>
	
    <!-- Create the eclipse data file -->
	<target name="data" depends="benchmark,plugin,osgiclasses" description="--> build the eclipse data file">
		<!-- Create the fake jre -->
	    <unzip dest="${build.src}/eclipse/dummyjre" src="${data}/eclipse/dummyjre.zip"/>

	    <!-- Install the test data -->
	    <zip destfile="${zipdata}/eclipse.zip">
	    	<!-- The dummy jre -->
	        <fileset dir="${build.src}/eclipse/" includes="dummyjre/**"/>

	        <!-- The eclipse runtime.  We just include as little as we can, -->
	        <!-- using an empirically derived list of what we really need.  -->
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/*"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/about_files/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/configuration/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/features/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/readme/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/dacapo.eclipse_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.apache.ant_*/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.core.expressions_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.core.resources_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.core.runtime.compatibility_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.core.runtime_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.core.variables_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.debug.core_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.jdt.core.tests.builder_*/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.jdt.core.tests.compiler_*/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.jdt.core.tests.performance_*/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.jdt.core_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.jdt.launching_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.jdt.debug_*/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.osgi_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.test.performance_*/**"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.text_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.eclipse.update.configurator_*.jar"/>
	        <fileset dir="${build.src}/eclipse/" includes="eclipse/plugins/org.junit_*/**"/>
	    </zip>
	</target>

	<!-- gut org.eclipse.osgi_XXXX.jar of its classes, which will become part of the main jar -->
    <target name="osgiclasses" depends="benchmark">
        <property name="osgihack" value="${build.src}/eclipse/osgihack"/>
        <!-- unzip the jar -->
        <unzip dest="${osgihack}" src="${eclipse-top}/plugins/org.eclipse.osgi_${eclipse.version}.jar"/>
        <!-- copy out the class files -->
        <copy todir="${build}">
            <fileset dir="${osgihack}" includes="org/**/*"/>
        </copy>
        <!-- conditionally clean out the stuff we've duplicated -->
        <!--    <antcall target="eclipse.clearosgi"/> -->
        <delete dir="${osgihack}/org"/>
        <!-- jar up the remainder -->
        <zip basedir="${osgihack}" includes="**/*" destfile="${eclipse-top}/plugins/org.eclipse.osgi_${eclipse.version}.jar"/>
        <delete dir="${osgihack}"/>
    </target>
	
    <!-- build the eclipse plugin, which is necessary to fire up eclipse from within our harness -->
    <target name="plugin" depends="benchmark,harness" description="--> build the eclipse harness">
        <ant antfile="build.xml" dir="${extra}/eclipse-plugin" 
         target="build.update.jar" inheritall="false">
            <property name="eclipsesrc.home" location="${eclipse-top}"/>
            <property name="harness.home" location="${build}"/>
            <property name="plugin.destination" location="${eclipse-top}/plugins/"/>
        </ant>
    </target>
   </project>
