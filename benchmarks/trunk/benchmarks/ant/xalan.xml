<project name="xalan" default="all" basedir="..">
    <description>Dacapo Xalan benchmark</description>
    
	<property file="ant/dacapo.properties"/>
	
	<property name="bm-name" value="xalan"/>
    <property name="bm-version" value="2_4_1"/>
    <property name="bm-url" value="${apache.dl.url}/xml/xalan-j/source"/>
    <property name="bm-dat-url" value="http://www.w3.org/TR/2001/WD-xforms-20010608/WD-xforms-20010608.zip"/>
	<property name="bm-src" value="${bm-name}-j_${bm-version}-src.tar.gz"/>
	<property name="bm-top" value="${build.src}/${bm-name}"/>
	<property name="bm-files" value="${basedir}/${bm-name}"/>
	
	<target name="all">
	    <antcall target="source"/>
	    <antcall target="build"/>
	</target>
	
    <target name="source">
        <get src="${bm-url}/${bm-src}" dest="${sources}/${bm-src}" usetimestamp="true"/>
        <get src="${bm-data-url}" dest="${sources}/xalan.data.zip" usetimestamp="true"/>
    </target>

    <target name="build" depends="benchmark,data,harness" description="--> build the derby benchmark"/>

	<!-- Build the xalan benchmark harness -->
	<target name="harness" depends="benchmark" description="Build xalan">
	     <copy file="${bm-files}/${bm-name}.cnf" todir="${build}/cnf"/>
        <javac srcdir="${bmsrc}" source="1.5" classpath="${build}" destdir="${build}" 
            includes="dacapo/xalan/*"
            debug="true" debuglevel="lines,vars,source"/>
		<mkdir dir="${bm-top}/benchmark"/>
		<javac srcdir="${bmsrc}" source="1.5" classpath="${jars}/xalan.jar" 
			destdir="${bm-top}/benchmark/" 
		    includes="dacapo/xalan/benchmark/*"
		    debug="true" debuglevel="lines,vars,source"/>
		<jar destfile="${jars}/xalan-benchmark.jar" basedir="${build.src}/xalan/benchmark"/>
    </target>
	
    <!-- Build the xalan input data -->
    <target name="data" description="Create data zip">
        <mkdir dir="${xalan-top}/xalan-data/xalan/"/>
        <unzip src="${sources}/xalan.data.zip" dest="${xalan-top}/xalan-data/xalan/">
            <patternset>
                <include name="*.xml"/>
                <include name="xmlspec.xsl"/>
            </patternset>
        </unzip>
        <zip basedir="${xalan-top}/xalan-data/" includes="xalan/**" destfile="${zipdata}/xalan.zip"/>
    </target>
	
    <!-- Build the xalan benchmark -->
    <target name="benchmark" description="Build xalan">
        <!-- Ensure xerces is built -->
        <ant antfile="${ant.dir}/xerces.xml" target="build"/>
        
        <property name="xalan-top" value="${bm-top}/xalan-j_${bm-version}"/>
        <property name="xalan.xerces.jar" value="${xerces-top}/xerces-${xerces._version}/${xerces.jar}"/>
        <property name="xalan.xercesxml.jar" value="${xerces-top}/xerces-${xerces._version}/${xercesxml.jar}"/>
        <mkdir dir="${build.src}/xalan"/>

        <!-- Unpack the source distribution -->
        <untar src="${sources}/xalan-j_${bm-version}-src.tar.gz" dest="${build.src}/xalan" compression="gzip"/>

        <!-- Apply the dacapo patch -->
        <patch patchfile="${patches}/xalan.patch" dir="${build.src}" strip="0"/>

        <!-- Build using Ant, setting the classpath appropriately -->
        <exec dir="${xalan-top}" executable="ant">
            <env key="CLASSPATH" value=".:${build}:${build}/xercesImpl.jar:${build}/xml-apis.jar"/>
            <env key="ANT_HOME" value="${ant.install}"/>
        </exec>

        <antcall target="deps"/>

        <!-- Grab the xalan class files from the built jar files -->
        <copy file="${xalan-top}/build/xalan.jar" todir="${jars}"/>
    </target>
	
    <!-- Add external libraries to the deps -->
    <target name="deps" if="externalize.deps" description="--> add the chart libraries to the build">
        <copy file="${xalan-top}/bin/xml-apis.jar" todir="${build.deps}"/>
        <copy file="${xalan-top}/bin/xercesImpl.jar" todir="${build.deps}"/>
    </target>
</project>