<project name="DacapoJython" default="all" basedir="..">
    <description>Dacapo jython benchmark</description>
    
	<property file="ant/dacapo.properties"/>
	
	<property name="bm.name" value="jython"/>
    <property name="bm.version" value="2.2.1"/>
    <property name="bm._version" value="2_2.1"/>
    <property name="bm.url" value="${sourceforge.dl.url}/jython"/>
    <property name="python.version" value="2.5"/>
    <property name="python.url" value="http://www.python.org/ftp/python/2.5/"/>

    <!-- Download and build -->
    <target name="all" description="download and build the benchmark">
      <antcall target="source"/>
      <antcall target="build"/>
    </target>
    
	<!-- Download the source -->
	<target name="source" description="download the benchmark">
		<get src="${bm.url}/${bm.name}_installer-${bm.version}.jar"
	     	dest="${sources}/${bm.name}_installer-${bm.version}.jar"
	   		usetimestamp="true"/>
		<get src="${python.url}/Python-${python.version}.tgz"
		 	dest="${sources}/Python-${python.version}.tgz"  
			usetimestamp="true"/>
	</target>

	<!-- Build the benchmark and harness -->
    <target name="build" depends="benchmark,harness" description="build the benchmark"/>
	
    <!-- Build the benchmark harness -->
    <target name="harness">
        <javac srcdir="${bmsrc}" classpath="${build}" destdir="${build}" 
            source="1.5"
            includes="dacapo/${bm.name}/*"
            debug="true" debuglevel="lines,vars,source"/>
    </target>

    <!-- Build the benchmark -->
    <target name="benchmark">
        <property name="jython-top" value="${build.src}/jython/"/>
        <mkdir dir="${jython-top}/jython_${bm._version}"/>

        <unzip src="${sources}/jython_installer-${bm.version}.jar" dest="${jython-top}/jython_${bm.version}"/>

        <!-- Apply the dacapo patch, which allows us to set the arguments -->
        <patch patchfile="${patches}/jython.patch" 
                 dir="${jython-top}/jython_${bm.version}/src/java"
                 strip="0" ignorewhitespace="yes"/>

        <!-- copy requisite files into place-->
        <copy todir="${jython-top}/jython_${bm.version}/src/java">
            <fileset file="${jython-top}/jython_${bm.version}/build.*"/>
        </copy>

        <!-- Build jython -->
        <ant antfile="build.xml" dir="${jython-top}/jython_${bm.version}/src/java" inheritall="false">
            <property name="javaccHome2" location="${javacchome}"/>
            <property name="python.lib" location="${jython-top}/jython_${bm.version}/Lib"/>
        </ant>

        <!-- Copy files to the distribution directory -->
        <copy file="${jython-top}/jython_${bm.version}/src/java/dist/jython.jar" todir="${jars}"/>
        <antcall target="deps"/>

        <!-- Extract the pybench benchmark from the python sources -->
        <untar src="${sources}/Python-${python.version}.tgz" dest="${jython-top}" compression="gzip">
            <patternset>
                <include name="Python-${python.version}/Tools/pybench/**"/>
            </patternset>
        </untar>
        <move file="${jython-top}/Python-${python.version}/Tools/pybench" todir="${jython-top}/jython"/>


        <!-- patch the pybench benchmark to allow it to work with jython -->
        <patch patchfile="${patches}/pybench.patch" 
                 dir="${jython-top}/jython"
                 strip="0" ignorewhitespace="yes"/>
        <copy todir="${jython-top}/jython/Lib">
            <fileset dir="${jython-top}/jython_${bm.version}/Lib"/>
        </copy>


        <!-- Install the test data -->
        <zip destfile="${zipdata}/jython.zip">
            <fileset dir="${data}/" includes="jython/noop.py"/>
            <fileset dir="${data}/" includes="jython/sieve.py"/>
            <fileset dir="${jython-top}/" includes="jython/pybench/**"/>
            <fileset dir="${jython-top}/" includes="jython/Lib/**"/>
        </zip>
    </target>
	
	<!-- external dependencies -->
	<target name="deps">
    	<copy file="${build.src}/ant/ant.jar" todir="${build.deps}"/>
    	<copy file="${build.src}/ant/ant-launcher.jar" todir="${build.deps}"/>
	</target>

</project>
